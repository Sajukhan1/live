<script>
const CLIENT_ID = "660995424565-gqjg9cis8bojph9clv7vjuv3knpp9er0.apps.googleusercontent.com";
const REDIRECT_URI = "https://saju-live.vercel.app/";
let accessToken = null;

function startOAuth() {
  const scopes = encodeURIComponent(
    "https://www.googleapis.com/auth/youtube.readonly https://www.googleapis.com/auth/youtube.force-ssl https://www.googleapis.com/auth/youtube"
  );
  const url = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=token&scope=${scopes}&include_granted_scopes=true&prompt=consent`;
  window.location.href = url;
}

document.getElementById('loginBtn').addEventListener('click', () => {
  startOAuth();
});

document.getElementById('logoutBtn').addEventListener('click', () => {
  localStorage.removeItem("access_token");
  accessToken = null;
  document.getElementById("loginBtn").style.display = "inline-block";
  document.getElementById("logoutBtn").style.display = "none";
  alert("Logged out!");
});

document.getElementById('checkBtn').addEventListener('click', () => {
  const videoId = document.getElementById('videoIdInput').value.trim();
  if (!videoId) {
    alert('Please enter a YouTube video ID.');
    return;
  }
  checkRegionRestrictions(videoId);
});

function checkRegionRestrictions(videoId) {
  if (!accessToken) {
    alert("Please login first!");
    return;
  }

  const url = `https://www.googleapis.com/youtube/v3/videos?part=contentDetails,snippet&id=${videoId}`;
  fetch(url, {
    headers: {
      Authorization: "Bearer " + accessToken
    }
  })
  .then(res => res.json())
  .then(data => {
    console.log(data);
    if (!data.items || data.items.length === 0) {
      showResult("‚ùå No video found with this ID or it is private.");
      return;
    }
    const video = data.items[0];
    const title = video.snippet.title;
    const regionRestriction = video.contentDetails.regionRestriction || {};

    let allowed = regionRestriction.allowed || [];
    let blocked = regionRestriction.blocked || [];

    let html = `<h3>Title: ${title}</h3>`;

    if (allowed.length > 0) {
      html += `<p class="allowed"><strong>Allowed Countries:</strong> ${allowed.join(", ")}</p>`;
      html += `<p class="blocked">All other countries are blocked.</p>`;
    } else if (blocked.length > 0) {
      html += `<p class="blocked"><strong>Blocked Countries:</strong> ${blocked.join(", ")}</p>`;
      html += `<p class="allowed">All other countries are allowed.</p>`;
    } else {
      html += `<p>‚úÖ There is no region restriction on this video.</p>`;
    }

    showResult(html);
  })
  .catch(err => {
    console.error(err);
    showResult("Error fetching video details. Please try logging in again.");
    localStorage.removeItem("access_token");
    document.getElementById("loginBtn").style.display = "inline-block";
    document.getElementById("logoutBtn").style.display = "none";
  });
}

function showResult(html) {
  const resultDiv = document.getElementById('result');
  resultDiv.style.display = 'block';
  resultDiv.innerHTML = html;
}

// When page loads, try to read token from URL or storage
window.onload = () => {
  const hash = window.location.hash;
  if (hash.includes("access_token")) {
    const params = new URLSearchParams(hash.substring(1));
    accessToken = params.get("access_token");
    localStorage.setItem("access_token", accessToken);
    window.history.replaceState({}, document.title, window.location.pathname);
  } else {
    accessToken = localStorage.getItem("access_token");
  }

  if (accessToken) {
    document.getElementById("loginBtn").style.display = "none";
    document.getElementById("logoutBtn").style.display = "inline-block";
  } else {
    // üî• Auto-login if token not found
    startOAuth();
  }
};
</script>
